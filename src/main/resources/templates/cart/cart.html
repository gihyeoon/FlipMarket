<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ko">

<head>
	<meta charset="UTF-8">
	<title>Ïû•Î∞îÍµ¨Îãà</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
	<div class="max-w-5xl mx-auto p-4">
		<h2 class="text-2xl font-bold mb-6">üõí Ïû•Î∞îÍµ¨Îãà</h2>

		<div class="space-y-4">
			<div th:each="item, itemStat : ${cartItems}"
				class="cart-items flex items-center border p-4 rounded-lg shadow-sm">
				<img th:src="@{|/images/${item.imagePath}}" alt="ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ" class="w-24 h-24 object-cover rounded-md mr-4">

				<div class="flex-1">
					<h3 class="text-lg font-semibold" th:text="${item.productName}"></h3>
					<p class="text-sm text-gray-500" th:text="${item.category}"></p>

					<div class="item-quantity flex items-center mt-2">
						<button type="button" class="minus px-2 py-1 bg-gray-200 rounded"
							onclick="minusQuantity(this)">-</button>
						<span class="quantity mx-2" th:text="${item.quantity}"></span>
						<button type="button" class="plus px-2 py-1 bg-gray-200 rounded"
							onclick="plusQuantity(this)">+</button>
					</div>
				</div>

				<div class="text-right ml-4">
					<span class="unit-price" th:text="${item.price}" hidden></span>
					<p class="total-unit-price text-lg font-bold text-blue-600"
						th:text="${#numbers.formatInteger(item.price * item.quantity, 3, 'COMMA')} + 'Ïõê'">
					</p>
					<button class="mt-2 text-sm text-red-500">ÏÇ≠Ï†ú</button>
				</div>
			</div>
		</div>

		<div class="mt-8 text-right">
			<span id="originTotalPrice" th:text="${totalPrice}" hidden></span>
			<span id="unFormattedTotalPrice" th:text="${totalPrice}" hidden></span>
			<p class="text-xl font-semibold">Ï¥ùÌï©Í≥Ñ: <span id="totalPrice" class="text-blue-700"
					th:text="${#numbers.formatInteger(totalPrice, 3, 'COMMA')} + 'Ïõê'"></span></p>

			<div class="mt-4 flex justify-end space-x-2">
				<a href="/" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Î©îÏù∏ÏúºÎ°ú</a>
				<button type="button" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="purchase(event);">Ï£ºÎ¨∏ÌïòÍ∏∞</button>
			</div>
		</div>
	</div>
</body>

</html>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		function plusQuantity(button) {
			let item = $(button).closest(".cart-items");
			let quantity = item.find(".quantity");
			let unitPrice = parseInt(item.find(".unit-price").text());
			let count = parseInt(quantity.text());

			count++;
			quantity.text(count);

			updateTotalUnitPrice(item, count, unitPrice);
		}

		function minusQuantity(button) {
			let item = $(button).closest(".cart-items");
			let quantity = item.find(".quantity");
			let unitPrice = parseInt(item.find(".unit-price").text());
			let count = parseInt(quantity.text());

			if (count > 1) {
				count--;
				quantity.text(count);
				updateTotalUnitPrice(item, count, unitPrice);
			}
		}

		function updateTotalUnitPrice(item, count, unitPrice) {
			const total = count * unitPrice;
			const formattedTotal = total.toLocaleString();
			item.find(".total-unit-price").text(formattedTotal + "Ïõê");
			
			refreshTotalPrice();
		}
		
		function refreshTotalPrice() {
			let total = 0;
			
			$(".cart-items").each(function () {
				const quantity = parseInt($(this).find(".quantity").text());
				const unitPrice = parseInt($(this).find(".unit-price").text());
				total += quantity * unitPrice;
			});
			
			const formattedTotalPrice = total.toLocaleString();
			$("#totalPrice").text(formattedTotalPrice + "Ïõê");
			$("#unFormattedTotalPrice").text(total);
		}
	</script>
</th:block>